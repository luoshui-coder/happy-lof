# 子路径部署完成指南

## ✅ 已完成的修改

### 1. 前端代码修改 ✓
已将 `static/index.html` 中的 API 路径从绝对路径改为相对路径：

**修改内容**：
- ❌ `fetch('/api/lof')` → ✅ `fetch('api/lof')`
- ❌ `fetch('/api/lof/history/...')` → ✅ `fetch('api/lof/history/...')`
- ❌ `href="/static/chicken.png"` → ✅ `href="chicken.png"`

**优点**：
- 无论应用部署在哪个路径下，相对路径都能正常工作
- 不需要硬编码路径前缀

### 2. Nginx 配置文件 ✓
已创建 `nginx-final-config.conf`，包含以下关键配置：

```nginx
# 根路径自动跳转
location = / {
    return 301 https://$host/happy-lof;
}

# happy-lof 应用
location /happy-lof {
    rewrite ^/happy-lof(.*)$ $1 break;
    proxy_pass http://127.0.0.1:5000;
    ...
}

# 其他路径返回 404
location / {
    return 404;
}
```

---

## 🚀 部署步骤

### 步骤 1：更新服务器代码

将修改后的 `static/index.html` 上传到服务器：

```bash
# 方法 1：使用 Git（推荐）
cd /www/wwwroot/happy-lof
git pull

# 方法 2：使用 SCP
scp static/index.html root@your-server:/www/wwwroot/happy-lof/static/

# 方法 3：在宝塔面板文件管理中直接编辑
```

### 步骤 2：更新 Nginx 配置

1. **登录宝塔面板**
2. **进入网站设置**：网站 → luoshui.top → 设置
3. **修改配置文件**：点击"配置文件"
4. **复制新配置**：将 `nginx-final-config.conf` 的内容粘贴进去
5. **保存**：点击保存按钮

### 步骤 3：重启 Nginx

在宝塔面板中：
- 软件商店 → Nginx → 重启

或者 SSH 执行：
```bash
sudo systemctl restart nginx
```

### 步骤 4：测试访问

打开浏览器测试以下 URL：

1. **根路径（自动跳转）**
   ```
   https://luoshui.top/
   ```
   应该自动跳转到 `https://luoshui.top/happy-lof`

2. **应用首页**
   ```
   https://luoshui.top/happy-lof
   ```
   应该显示"今乐福"首页

3. **API 接口**
   ```
   https://luoshui.top/happy-lof/api/lof
   ```
   应该返回 JSON 数据

4. **静态资源**
   ```
   https://luoshui.top/happy-lof/chicken.png
   ```
   应该显示图标

---

## 🔍 验证清单

- [ ] `https://luoshui.top/` 自动跳转到 `/happy-lof`
- [ ] `https://luoshui.top/happy-lof` 显示首页
- [ ] 页面数据正常加载（无 API 错误）
- [ ] 图标正常显示
- [ ] 刷新按钮正常工作
- [ ] 历史溢价率走势图正常显示

---

## 📊 工作原理

### 请求流程

```
用户访问: https://luoshui.top/happy-lof
    ↓
Nginx 接收请求: /happy-lof
    ↓
Rewrite 重写: /happy-lof → /
    ↓
代理转发: http://127.0.0.1:5000/
    ↓
Flask 处理: app.route('/')
    ↓
返回: static/index.html
    ↓
浏览器加载页面
    ↓
JavaScript 发起请求: fetch('api/lof')
    ↓
相对路径解析: https://luoshui.top/happy-lof/api/lof
    ↓
Nginx 接收: /happy-lof/api/lof
    ↓
Rewrite 重写: /happy-lof/api/lof → /api/lof
    ↓
代理转发: http://127.0.0.1:5000/api/lof
    ↓
Flask 处理: app.route('/api/lof')
    ↓
返回 JSON 数据
```

### 关键点

1. **Nginx Rewrite**：去掉 `/happy-lof` 前缀，Flask 应用无感知
2. **相对路径**：前端使用相对路径，自动适配当前路径
3. **自动跳转**：根路径 `/` 自动跳转到 `/happy-lof`

---

## 🚨 常见问题

### 问题 1：页面显示空白

**可能原因**：
- Nginx 配置未生效
- Flask 应用未启动

**解决方法**：
```bash
# 检查 Nginx 配置
sudo nginx -t

# 检查 Flask 应用
ps aux | grep python
netstat -tlnp | grep :5000

# 重启服务
sudo systemctl restart nginx
```

### 问题 2：API 请求 404

**可能原因**：
- 前端代码未更新
- Nginx rewrite 规则错误

**解决方法**：
1. 检查浏览器控制台，查看实际请求的 URL
2. 确认 `static/index.html` 已更新
3. 检查 Nginx 配置中的 rewrite 规则

### 问题 3：静态资源 404

**可能原因**：
- 静态文件路径不正确

**解决方法**：
确保 `chicken.png` 在正确位置：
```bash
ls -la /www/wwwroot/happy-lof/static/chicken.png
```

### 问题 4：访问根路径不跳转

**可能原因**：
- Nginx 配置中的 `location = /` 未生效

**解决方法**：
检查 Nginx 配置文件中是否有其他 `location /` 规则冲突

---

## 📝 回滚方案

如果部署后出现问题，可以快速回滚：

### 回滚 Nginx 配置

1. 在宝塔面板中恢复原配置
2. 将 `location /happy-lof` 改回 `location /`
3. 删除 `location = /` 跳转规则

### 回滚前端代码

将 API 路径改回绝对路径：
```javascript
// 回滚为
fetch('/api/lof')
fetch('/api/lof/history/...')
```

---

## 🎯 小程序配置

部署完成后，记得在微信小程序后台配置服务器域名：

1. **登录小程序后台**
2. **开发 → 开发管理 → 开发设置 → 服务器域名**
3. **添加 request 合法域名**：
   ```
   https://luoshui.top
   ```

**注意**：
- 小程序中的 API 请求需要使用完整路径：
  ```javascript
  wx.request({
    url: 'https://luoshui.top/happy-lof/api/lof',
    ...
  })
  ```

---

## ✅ 完成确认

部署完成后，请确认以下内容：

- [ ] 前端代码已更新到服务器
- [ ] Nginx 配置已更新
- [ ] Nginx 已重启
- [ ] 所有测试 URL 都正常访问
- [ ] 浏览器控制台无错误
- [ ] 数据正常加载和显示

---

**预计部署时间：15 分钟**

如有问题，请查看：
- Nginx 错误日志：`/www/wwwlogs/happy-lof.error.log`
- Flask 应用日志：检查应用输出
- 浏览器控制台：F12 → Console/Network
