# 今乐福小程序发布指南

> 基于现有服务器 `luoshui.life:5000` 的完整部署流程

## 📋 当前状态

- ✅ 后端服务已部署：`http://luoshui.life:5000`
- ✅ Web 版本可访问
- ⏳ 需要配置 HTTPS
- ⏳ 需要上传小程序代码

---

## 🚀 部署步骤

### 第一步：配置 HTTPS（必须）

小程序要求后端必须使用 HTTPS 协议。您有以下几种方式：

#### 方案 A：使用宝塔面板配置 SSL（推荐）

1. **登录宝塔面板**
   ```
   访问您的宝塔面板地址
   ```

2. **申请 SSL 证书**
   - 进入 **网站** → 找到 `luoshui.life` 站点
   - 点击 **SSL** 标签
   - 选择 **Let's Encrypt**（免费）
   - 点击 **申请**
   - 勾选 **强制 HTTPS**

3. **验证 HTTPS**
   ```bash
   # 访问以下地址测试
   https://luoshui.life/api/lof
   ```

#### 方案 B：使用 Nginx 反向代理（如果没有宝塔）

1. **申请 SSL 证书**
   ```bash
   # 使用 certbot 申请免费证书
   sudo certbot certonly --nginx -d luoshui.life
   ```

2. **配置 Nginx**
   
   编辑 Nginx 配置文件：
   ```nginx
   # HTTPS 服务
   server {
       listen 443 ssl http2;
       server_name luoshui.life;
       
       # SSL 证书配置
       ssl_certificate /etc/letsencrypt/live/luoshui.life/fullchain.pem;
       ssl_certificate_key /etc/letsencrypt/live/luoshui.life/privkey.pem;
       ssl_protocols TLSv1.2 TLSv1.3;
       ssl_ciphers HIGH:!aNULL:!MD5;
       
       # 反向代理到 Flask 应用
       location / {
           proxy_pass http://127.0.0.1:5000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
   }
   
   # HTTP 自动跳转到 HTTPS
   server {
       listen 80;
       server_name luoshui.life;
       return 301 https://$server_name$request_uri;
   }
   ```

3. **重启 Nginx**
   ```bash
   sudo nginx -t
   sudo systemctl reload nginx
   ```

---

### 第二步：修改小程序 API 配置

1. **编辑 `miniprogram/app.js`**
   
   将 API 地址改为 HTTPS：
   ```javascript
   globalData: {
     // 生产环境：使用 HTTPS 域名
     apiBase: 'https://luoshui.life/api',
     
     // 开发环境备用
     // apiBase: 'http://127.0.0.1:5003/api',
   }
   ```

2. **测试 API 连接**
   
   在微信开发者工具中测试是否能正常获取数据。

---

### 第三步：配置微信公众平台

#### 1. 登录微信公众平台

访问：https://mp.weixin.qq.com

#### 2. 配置服务器域名白名单

1. 进入 **开发** → **开发管理** → **开发设置**
2. 找到 **服务器域名**，点击 **修改**
3. 配置以下域名：

   | 类型 | 域名 |
   |------|------|
   | **request 合法域名** | `https://luoshui.life` |

4. 点击 **保存并提交**

> ⚠️ **重要提示**：
> - 域名必须使用 HTTPS
> - 域名必须已备案
> - 每月只能修改 5 次

#### 3. 获取小程序 AppID

在 **开发** → **开发设置** 中查看并复制 **AppID**

---

### 第四步：配置小程序项目

1. **编辑 `miniprogram/project.config.json`**
   
   将 `appid` 改为您的小程序 AppID：
   ```json
   {
     "appid": "wxXXXXXXXXXXXXXXXX",
     "projectname": "happy-lof",
     ...
   }
   ```

2. **检查小程序基本信息**
   
   确保 `miniprogram/app.json` 配置正确：
   ```json
   {
     "pages": [
       "pages/index/index",
       "pages/detail/detail"
     ],
     "window": {
       "navigationBarTitleText": "今乐福",
       "navigationBarBackgroundColor": "#667eea",
       "navigationBarTextStyle": "white"
     }
   }
   ```

---

### 第五步：使用微信开发者工具上传代码

#### 1. 打开项目

1. 启动 **微信开发者工具**
2. 选择 **导入项目**
3. 项目目录：`/Users/luoshui/ai_coding/git/happy-lof/miniprogram`
4. AppID：填写您的小程序 AppID

#### 2. 本地测试

1. 点击右上角 **详情**
2. **暂时勾选**"不校验合法域名..."（仅用于开发测试）
3. 测试所有功能是否正常：
   - ✅ 基金列表加载
   - ✅ 下拉刷新
   - ✅ 点击复制代码
   - ✅ 点击卡片跳转详情页
   - ✅ 详情页趋势图显示

#### 3. 真机预览（重要）

1. 点击工具栏 **预览** 按钮
2. 使用微信扫描二维码
3. 在手机上测试：
   - ✅ 网络请求是否正常（必须使用 HTTPS）
   - ✅ 所有功能是否可用
   - ✅ 性能是否流畅

> ⚠️ **注意**：真机预览时必须取消勾选"不校验合法域名"，确保使用 HTTPS

#### 4. 上传代码

1. 确保所有测试通过
2. 点击工具栏 **上传** 按钮
3. 填写版本信息：
   - **版本号**：`1.0.0`
   - **项目备注**：`初始版本，LOF基金套利溢价查询工具`
4. 点击 **上传**

---

### 第六步：提交审核

#### 1. 登录微信公众平台

访问：https://mp.weixin.qq.com

#### 2. 进入版本管理

1. 进入 **版本管理** → **开发版本**
2. 找到刚上传的版本（版本号 1.0.0）

#### 3. 提交审核

1. 点击 **提交审核**
2. 填写审核信息：

   **基本信息：**
   - **小程序名称**：今乐福
   - **小程序简介**：LOF基金套利溢价实时监控工具，帮助投资者发现套利机会
   - **服务类目**：
     - 一级类目：**金融业** 或 **工具**
     - 二级类目：**基金** 或 **信息查询**

   **功能页面：**
   - **页面路径**：`pages/index/index`
   - **页面标题**：基金列表
   - **页面截图**：上传首页截图

   **实际经营内容描述（20-200字）：**
   ```
   本小程序为LOF（上市型开放式基金）投资者提供专业的溢价率监控工具。主要服务包括：1.实时获取并展示LOF基金溢价率数据；2.智能筛选符合套利条件的基金（溢价率≥1%、成交额≥1000万）；3.提供历史溢价趋势图表分析；4.套利难度智能评级；5.交易所标识及持有天数提示。数据仅供投资参考，不构成投资建议。
   ```

3. **隐私设置**：
   - 勾选"不涉及用户隐私信息"（如果确实不收集）
   - 或提供隐私政策链接

4. 点击 **提交审核**

---

### 第七步：等待审核并发布

#### 审核时间

- 通常 1-7 个工作日
- 可在 **版本管理** 中查看审核进度

#### 审核通过后

1. 会收到微信通知
2. 进入 **版本管理** → **审核版本**
3. 点击 **发布**
4. 发布后用户即可搜索使用

---

## 📝 发布前检查清单

### 服务器端
- [ ] HTTPS 已配置并可访问
- [ ] API 接口 `https://luoshui.life/api/lof` 正常返回数据
- [ ] 服务器稳定运行，已配置自动重启
- [ ] 定时任务正常运行（每天 14:55 记录数据）

### 小程序端
- [ ] `app.js` 中 API 地址已改为 HTTPS
- [ ] `project.config.json` 中 AppID 已配置
- [ ] 微信公众平台已配置服务器域名白名单
- [ ] 本地开发者工具测试通过
- [ ] 真机预览测试通过（使用 HTTPS）
- [ ] 所有功能正常：列表、刷新、复制、详情页

### 审核材料
- [ ] 小程序名称、图标、简介已准备
- [ ] 服务类目已选择（金融/工具）
- [ ] 实际经营内容描述已填写（20-200字）
- [ ] 功能页面截图已准备
- [ ] 隐私政策已准备（如需要）

---

## ⚠️ 常见问题

### 1. 真机预览时网络请求失败

**原因**：
- 后端未配置 HTTPS
- 域名未在白名单中
- 开发者工具中勾选了"不校验合法域名"

**解决**：
1. 确保后端使用 HTTPS
2. 在微信公众平台配置域名白名单
3. 真机测试时取消勾选"不校验合法域名"

### 2. 审核被拒绝

**常见原因**：
- 服务类目选择不当
- 功能描述不清晰
- 缺少必要的资质（如金融类需要特殊资质）

**解决**：
- 选择"工具 → 信息查询"类目（避免金融类目）
- 强调"数据仅供参考，不构成投资建议"
- 根据审核意见修改后重新提交

### 3. HTTPS 证书配置失败

**解决**：
- 确保域名已备案
- 检查 DNS 解析是否正确
- 使用宝塔面板自动申请 Let's Encrypt 证书
- 或手动使用 certbot 申请

---

## 🔄 后续维护

### 版本更新

1. 修改代码后重新上传
2. 填写新版本号（如 1.0.1）
3. 提交审核
4. 审核通过后发布

### 监控和优化

1. 在微信公众平台查看数据统计
2. 收集用户反馈
3. 优化性能和体验
4. 定期更新功能

---

## 📞 需要帮助？

- 微信小程序官方文档：https://developers.weixin.qq.com/miniprogram/dev/framework/
- 微信公众平台：https://mp.weixin.qq.com
- 项目 GitHub：https://github.com/luoshui-coder/happy-lof

---

## 🎉 发布成功后

用户可以通过以下方式找到您的小程序：
1. 微信搜索"今乐福"
2. 扫描小程序码
3. 分享给好友

祝发布顺利！🚀
