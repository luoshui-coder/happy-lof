# 今乐福小程序发布 - 快速操作清单

> 基于您当前的配置：`luoshui.life:5000` 已部署

## ✅ 已完成的配置

- ✅ 小程序 AppID：`wx6d1d85df3e653654`
- ✅ 后端服务：`http://luoshui.life:5000`
- ✅ 小程序代码已准备完毕

---

## 🚀 立即开始（按顺序执行）

### 步骤 1：配置 HTTPS（最重要！）

**为什么必须？** 小程序要求后端必须使用 HTTPS 协议。

#### 使用宝塔面板（推荐）

1. 登录宝塔面板
2. 进入 **网站** → 找到 `luoshui.life`
3. 点击 **SSL** 标签
4. 选择 **Let's Encrypt**（免费）
5. 点击 **申请**
6. 勾选 **强制 HTTPS**
7. 测试访问：`https://luoshui.life/api/lof`

#### 如果没有宝塔面板

```bash
# SSH 连接到服务器后执行

# 1. 安装 certbot
sudo apt update
sudo apt install certbot python3-certbot-nginx

# 2. 申请证书
sudo certbot --nginx -d luoshui.life

# 3. 重启 Nginx
sudo systemctl reload nginx

# 4. 测试
curl https://luoshui.life/api/lof
```

---

### 步骤 2：修改小程序 API 地址

**文件**：`miniprogram/app.js`

**当前配置**：
```javascript
apiBase: 'http://luoshui.life:5000/api',
```

**需要改为**：
```javascript
apiBase: 'https://luoshui.life/api',
```

> ⚠️ 注意：去掉端口号 `:5000`，因为 HTTPS 默认使用 443 端口

---

### 步骤 3：配置微信公众平台域名白名单

1. **登录**：https://mp.weixin.qq.com
2. **进入**：开发 → 开发管理 → 开发设置
3. **找到**：服务器域名
4. **点击**：修改
5. **配置**：
   - request 合法域名：`https://luoshui.life`
6. **保存**

> ⚠️ 每月只能修改 5 次，请确认后再保存！

---

### 步骤 4：使用微信开发者工具测试

#### 4.1 打开项目

1. 启动微信开发者工具
2. 导入项目：`/Users/luoshui/ai_coding/git/happy-lof/miniprogram`
3. AppID：`wx6d1d85df3e653654`

#### 4.2 本地测试

1. 点击右上角 **详情**
2. **临时勾选**"不校验合法域名..."
3. 测试功能：
   - ✅ 基金列表加载
   - ✅ 下拉刷新
   - ✅ 点击复制代码
   - ✅ 暂停申购基金显示灰色
   - ✅ 点击卡片跳转详情页

#### 4.3 真机预览（重要！）

1. **取消勾选**"不校验合法域名"
2. 点击 **预览**
3. 用微信扫码
4. 在手机上测试所有功能

> ⚠️ 如果真机预览失败，说明 HTTPS 或域名白名单配置有问题

---

### 步骤 5：上传代码

1. 确保所有测试通过
2. 点击 **上传**
3. 填写：
   - 版本号：`1.0.0`
   - 备注：`初始版本 - LOF基金套利溢价查询`
4. 点击上传

---

### 步骤 6：提交审核

1. 登录微信公众平台：https://mp.weixin.qq.com
2. 进入 **版本管理** → **开发版本**
3. 点击 **提交审核**
4. 填写审核信息：

#### 基本信息
- **服务类目**：工具 → 信息查询（避免金融类目需要资质）
- **标签**：基金、查询、工具

#### 功能页面
- **页面路径**：`pages/index/index`
- **页面标题**：基金列表
- **页面截图**：上传首页截图

#### 实际经营内容（复制粘贴）
```
本小程序为LOF（上市型开放式基金）投资者提供专业的溢价率监控工具。主要服务包括：1.实时获取并展示LOF基金溢价率数据；2.智能筛选符合套利条件的基金（溢价率≥1%、成交额≥1000万）；3.提供历史溢价趋势图表分析；4.套利难度智能评级；5.交易所标识及持有天数提示。数据仅供投资参考，不构成投资建议。
```

#### 隐私设置
- 勾选"不涉及用户隐私信息"

5. 提交审核

---

### 步骤 7：等待审核

- 审核时间：1-7 个工作日
- 查看进度：版本管理 → 审核版本
- 审核通过后点击 **发布**

---

## 📋 发布前最终检查

### 服务器端
```bash
# 1. 检查 HTTPS 是否正常
curl https://luoshui.life/api/lof

# 2. 检查服务是否运行
ps aux | grep python

# 3. 检查端口
netstat -tlnp | grep 5000
```

### 小程序端
- [ ] `app.js` API 地址已改为 `https://luoshui.life/api`
- [ ] 微信公众平台域名白名单已配置
- [ ] 本地测试通过
- [ ] 真机预览通过（不勾选"不校验合法域名"）

---

## ⚠️ 可能遇到的问题

### 问题 1：真机预览网络请求失败

**错误信息**：`request:fail`

**原因**：
- HTTPS 未配置
- 域名未在白名单中

**解决**：
1. 确认 `https://luoshui.life/api/lof` 可以在浏览器访问
2. 确认微信公众平台已配置域名白名单
3. 确认 `app.js` 中使用的是 HTTPS 地址

### 问题 2：Nginx 配置 HTTPS 后端口冲突

**现象**：5000 端口被占用

**解决**：
```nginx
# Nginx 配置示例
server {
    listen 443 ssl http2;
    server_name luoshui.life;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

server {
    listen 80;
    server_name luoshui.life;
    return 301 https://$server_name$request_uri;
}
```

### 问题 3：审核被拒

**常见原因**：
- 服务类目选择不当（选了金融类目但没有资质）
- 功能描述不清晰

**解决**：
- 选择"工具 → 信息查询"类目
- 强调"数据仅供参考，不构成投资建议"
- 根据审核意见修改后重新提交

---

## 🎯 下一步

审核通过后：
1. 在微信公众平台点击 **发布**
2. 用户可以搜索"今乐福"找到小程序
3. 可以生成小程序码分享

---

## 📞 需要帮助？

如果遇到问题，可以：
1. 查看详细文档：`小程序发布指南.md`
2. 查看微信官方文档：https://developers.weixin.qq.com/miniprogram/dev/framework/
3. 查看服务器日志排查问题

---

**祝发布顺利！🚀**
