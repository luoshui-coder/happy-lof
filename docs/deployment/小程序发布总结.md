# 今乐福小程序发布 - 总结文档

## 📦 已完成的准备工作

### ✅ 代码准备
- [x] 小程序代码已完成
- [x] API 地址已更新为 HTTPS：`https://luoshui.life/api`
- [x] AppID 已配置：`wx6d1d85df3e653654`
- [x] 暂停申购基金样式已优化（灰色半透明）
- [x] 刷新按钮已固定在屏幕右下角

### ✅ 文档准备
- [x] `小程序发布清单.md` - 快速操作步骤
- [x] `小程序发布指南.md` - 详细发布流程
- [x] `nginx-https-config.conf` - Nginx HTTPS 配置示例
- [x] `check_server.sh` - 服务器检查脚本

---

## 🚀 发布流程（按顺序执行）

### 第一步：配置服务器 HTTPS ⭐️ 最重要

**目标**：让 `https://luoshui.life/api/lof` 可以正常访问

#### 方式 A：使用宝塔面板（推荐）
1. 登录宝塔面板
2. 网站 → luoshui.life → SSL
3. Let's Encrypt → 申请
4. 勾选"强制 HTTPS"

#### 方式 B：手动配置
```bash
# SSH 连接服务器后执行
sudo certbot --nginx -d luoshui.life
sudo systemctl reload nginx
```

#### 验证
```bash
# 在服务器上运行检查脚本
cd /path/to/happy-lof
./check_server.sh
```

或在浏览器访问：`https://luoshui.life/api/lof`

---

### 第二步：配置微信公众平台

1. **登录**：https://mp.weixin.qq.com
2. **路径**：开发 → 开发管理 → 开发设置 → 服务器域名
3. **配置**：
   - request 合法域名：`https://luoshui.life`
4. **保存**（每月只能改 5 次）

---

### 第三步：微信开发者工具测试

#### 3.1 打开项目
- 路径：`/Users/luoshui/ai_coding/git/happy-lof/miniprogram`
- AppID：`wx6d1d85df3e653654`

#### 3.2 本地测试
- 勾选"不校验合法域名"
- 测试所有功能

#### 3.3 真机预览 ⭐️ 关键
- **取消勾选**"不校验合法域名"
- 点击"预览"
- 微信扫码测试

> ⚠️ 如果真机预览失败，说明 HTTPS 或域名白名单有问题

---

### 第四步：上传代码

1. 点击"上传"
2. 版本号：`1.0.0`
3. 备注：`初始版本 - LOF基金套利溢价查询`

---

### 第五步：提交审核

#### 登录微信公众平台
https://mp.weixin.qq.com → 版本管理 → 开发版本 → 提交审核

#### 填写审核信息

**服务类目**：
- 工具 → 信息查询（推荐，无需特殊资质）
- 或 金融业 → 基金（需要金融资质）

**功能页面**：
- 页面路径：`pages/index/index`
- 页面标题：基金列表
- 页面截图：上传首页截图

**实际经营内容**（复制粘贴）：
```
本小程序为LOF（上市型开放式基金）投资者提供专业的溢价率监控工具。主要服务包括：1.实时获取并展示LOF基金溢价率数据；2.智能筛选符合套利条件的基金（溢价率≥1%、成交额≥1000万）；3.提供历史溢价趋势图表分析；4.套利难度智能评级；5.交易所标识及持有天数提示。数据仅供投资参考，不构成投资建议。
```

**隐私设置**：
- 勾选"不涉及用户隐私信息"

---

### 第六步：等待审核并发布

- 审核时间：1-7 个工作日
- 审核通过后点击"发布"
- 用户可搜索"今乐福"使用

---

## 📋 发布前检查清单

### 服务器端
- [ ] HTTPS 已配置：`https://luoshui.life` 可访问
- [ ] API 正常：`https://luoshui.life/api/lof` 返回数据
- [ ] Flask 服务运行中
- [ ] 定时任务已配置（每天 14:55）
- [ ] 运行 `./check_server.sh` 全部通过

### 微信公众平台
- [ ] 域名白名单已配置：`https://luoshui.life`
- [ ] AppID 已获取：`wx6d1d85df3e653654`

### 小程序代码
- [ ] `app.js` API 地址：`https://luoshui.life/api`
- [ ] 本地测试通过
- [ ] 真机预览通过（不勾选"不校验合法域名"）

### 审核材料
- [ ] 服务类目已选择
- [ ] 功能页面截图已准备
- [ ] 实际经营内容已填写

---

## ⚠️ 常见问题

### Q1: 真机预览时网络请求失败

**错误**：`request:fail`

**原因**：
- HTTPS 未配置
- 域名未在白名单

**解决**：
1. 确认 `https://luoshui.life/api/lof` 浏览器可访问
2. 确认微信公众平台已配置域名
3. 确认开发者工具中**未勾选**"不校验合法域名"

### Q2: 审核被拒绝

**常见原因**：
- 服务类目选择不当（金融类需要资质）
- 功能描述不清晰

**解决**：
- 选择"工具 → 信息查询"类目
- 强调"数据仅供参考，不构成投资建议"
- 根据审核意见修改后重新提交

### Q3: HTTPS 配置后端口冲突

**现象**：Nginx 和 Flask 都监听 5000 端口

**解决**：
- Nginx 监听 443（HTTPS）和 80（HTTP）
- Flask 监听 5000（本地）
- Nginx 反向代理到 Flask

---

## 📁 相关文件

| 文件 | 说明 |
|------|------|
| `小程序发布清单.md` | 快速操作步骤 |
| `小程序发布指南.md` | 详细发布流程 |
| `nginx-https-config.conf` | Nginx HTTPS 配置示例 |
| `check_server.sh` | 服务器检查脚本 |
| `miniprogram/app.js` | 小程序 API 配置 |
| `miniprogram/project.config.json` | 小程序项目配置 |

---

## 🎯 下一步

1. **立即执行**：配置 HTTPS（最重要）
2. **验证**：运行 `./check_server.sh`
3. **测试**：真机预览
4. **上传**：微信开发者工具上传代码
5. **审核**：提交审核
6. **发布**：审核通过后发布

---

## 📞 需要帮助？

- 微信小程序官方文档：https://developers.weixin.qq.com/miniprogram/dev/framework/
- 微信公众平台：https://mp.weixin.qq.com
- Let's Encrypt：https://letsencrypt.org/

---

**祝发布顺利！🚀**

如有问题，请查看详细文档或联系技术支持。
